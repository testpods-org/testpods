# TestPods Refactoring Tasks

This folder contains individual refactoring tasks identified from the codebase opportunities analysis, with a focus on **composition over inheritance** for the TestPod class hierarchy.

## Design Principles

All refactorings follow these key principles:

1. **BaseTestPod remains** - It provides essential cross-cutting concerns (state management, fluent API, common operations)
2. **Fluent interface coherence** - The developer-facing API must remain clean and readable
3. **Components are internal** - WorkloadManager, ServiceManager, StorageManager are implementation details, not exposed to users

## Task Overview

| # | Task | Priority | Effort | Category |
|---|------|----------|--------|----------|
| 01 | [Extract WorkloadManager](01-extract-workload-manager.md) | High | Large | Architecture |
| 02 | [Extract ServiceManager](02-extract-service-manager.md) | High | Medium | Architecture |
| 03 | [Extract StorageManager](03-extract-storage-manager.md) | High | Medium | Architecture |
| 04 | [Fix Init Script ConfigMap Mount](04-fix-init-script-configmap-mount.md) | Critical | Small | Bug Fix |
| 05 | [Fix Statement Resource Leak](05-fix-statement-resource-leak.md) | Medium | Small | Bug Fix |
| 06 | [Add Consistent Error Handling](06-add-consistent-error-handling.md) | High | Small | Reliability |
| 07 | [Fix Thread-Unsafe TestPodDefaults](07-fix-thread-unsafe-testpoddefaults.md) | High | Small | Thread Safety |
| 08 | [Mark KafkaPod Incomplete](08-mark-kafkapod-incomplete.md) | Low | Small | Documentation |
| 09 | [Fix Broken StatefulSetPod Methods](09-fix-broken-statefulsetpod-methods.md) | Critical | Small | Bug Fix |
| 10 | [Create ContainerSpec Builder](10-create-container-spec-builder.md) | Medium | Medium | Developer Experience |

## Recommended Execution Order

### Phase 1: Critical Bug Fixes (Do First)
1. **09-fix-broken-statefulsetpod-methods** - Unblocks StatefulSet-based pods
2. **04-fix-init-script-configmap-mount** - Fixes PostgreSQL init scripts
3. **06-add-consistent-error-handling** - Prevents orphaned resources

### Phase 2: Architecture Refactoring (Parallel)
These can be done in parallel:
- **01-extract-workload-manager**
- **02-extract-service-manager**
- **03-extract-storage-manager**

### Phase 3: Developer Experience
5. **10-create-container-spec-builder** - Improves API ergonomics

### Phase 4: Cleanup (Parallel)
These can be done in any order:
- **05-fix-statement-resource-leak**
- **07-fix-thread-unsafe-testpoddefaults**
- **08-mark-kafkapod-incomplete**

## Target Architecture

After completing tasks 01-03, the architecture becomes:

```
TestPod (interface)
    │
    └── BaseTestPod (abstract - common state, fluent API)
            │
            └── ComposableTestPod (abstract - composes managers)
                    │
                    ├── PostgreSQLPod
                    │   ├─ workload: StatefulSetManager
                    │   ├─ service: HeadlessServiceManager + NodePortServiceManager
                    │   └─ storage: PersistentStorageManager (optional)
                    │
                    ├── GenericTestPod
                    │   ├─ workload: DeploymentManager
                    │   ├─ service: ClusterIPServiceManager
                    │   └─ storage: NoOpStorageManager
                    │
                    └── (Future) BatchJobPod
                        ├─ workload: JobManager
                        ├─ service: None
                        └─ storage: EmptyDirStorageManager
```

## Benefits

1. **Reduced hierarchy** - From 4 levels to 3 levels
2. **No more duplication** - Common code in managers, not duplicated base classes
3. **Mix and match** - Combine any workload type with any service/storage type
4. **Easier testing** - Mock individual managers
5. **Fluent API preserved** - Developer experience unchanged

## Validation

Each task includes:
- Success criteria checklist
- Test plan
- Validation step with output file (`*_result.md`)

After implementing a task, the agent must:
1. Compare implementation to original goals
2. Run tests
3. Write validation results to the `_result.md` file
